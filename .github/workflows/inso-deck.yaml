name: Run Inso and Deck with Konnect

on:
  push:
    branches:
      - dev-linting
  pull_request:
    branches:
      - main

jobs:
  inso-and-deck:
    name: Run Inso and Deck Actions with Konnect
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Set up Node.js for Inso
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16"

      # Install Inso using official action
      - name: Setup Inso
        uses: kong/setup-inso@v1
        with:
          inso-version: "8.6.1"

      # Install docker-compose
      - name: Install Compose
        uses: ndeloof/install-compose-action@v0.0.1
        with:
          version: v2.1.0 # defaults to 'latest'
          legacy: true # will also install in PATH as `docker-compose`

      # Verify docker-compose running
      - name: Install Compose
        run: docker-compose --version

      # Run docker-compose
      - name: Docker-compose - Build the stack
        run: docker-compose -f ./docker/docker-compose-bankong-combined_local_portchange.yaml up -d

      # Run Inso tests // run this if you have a service deployed somewhere to test the test suite against
      - name: Run Inso Tests
        run: |
          inso run test uts_7eb220b290744c2e95c1c9565999d780 --env env_038c957f9f1749c8bc57927d9655f4b4

      # Install Deck using official action
      - name: Setup decK
        uses: kong/setup-deck@v1
        with:
          version: "1.40.2"

      # Check Deck is installed
      - name: Deck version
        run: deck version

      - name: Export openapi spec
        run: inso export spec spc_1331b1e403b5400a83ad8e2173148fe4 -o openapi.yaml

      - name: Run Spectral Lint
        run: inso lint spec openapi.yaml

      # Convert OpenAPI specs to DecK
      - name: Generate Kong declarative configuration from Spec
        run: deck file openapi2kong --spec openapi.yaml --output-file ./kong.yaml --select-tag gitops

      # Optional: Validate Configuration with Deck for Konnect
      - name: Validate Configuration with Deck for Konnect
        run: |
          echo "Validating configuration with Konnect..."
          deck file validate ./kong.yaml

      # Run Deck Sync for Konnect
      - name: Sync Configuration with Deck and Konnect
        env:
          KONG_KONNECT_TOKEN: ${{ secrets.KONG_KONNECT_TOKEN }}
        run: |
          echo "Syncing configuration with Konnect..."
          deck gateway sync ./kong.yaml --konnect-addr https://us.api.konghq.com --konnect-token $KONG_KONNECT_TOKEN --konnect-control-plane-name apiops-demo --select-tag gitops
