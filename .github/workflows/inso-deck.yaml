name: Run Inso and Deck with Konnect

on:
  push:
    branches:
      - kong-ee
  pull_request:
    branches:
      - main

jobs:
  inso-and-deck:
    name: Run Inso and Deck Actions with Konnect
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Install Inso using official action
      - name: Setup Inso
        uses: kong/setup-inso@v1
        with:
          inso-version: "8.6.1"

      # Install Deck using official action
      - name: Setup decK
        uses: kong/setup-deck@v1
        with:
          version: "1.40.2"

      # Check Deck is installed
      - name: Deck version
        run: deck version

      # Convert OpenAPI specs to DecK
      - name: Generate Kong declarative configuration from Spec
        run: deck file openapi2kong --spec ./demo-scenes/openapi-spec.yaml --output-file ./kong.yaml --select-tag gitops

      # Optional: Validate Configuration with Deck for Konnect
      - name: Validate Configuration with Deck for Konnect
        run: |
          echo "Validating configuration with Konnect..."
          deck file validate ./kong.yaml

      # Run Deck Sync for Konnect
      - name: Sync Configuration with Deck and Konnect
        env:
          KONG_KONNECT_TOKEN: ${{ secrets.KONG_KONNECT_TOKEN }}
        run: |
          echo "Syncing configuration with Konnect..."
          deck gateway sync ./kong.yaml -w TribeA --select-tag gitops --kong-addr https://sfp8q4jp-8001.asse.devtunnels.ms

      # Run Inso tests
      - name: Run Inso Tests
        run: |
          inso run test uts_7eb220b290744c2e95c1c9565999d780 --env env_038c957f9f1749c8bc57927d9655f4b4
